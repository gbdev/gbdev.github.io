<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.32">
    <meta name="og:title" content="DMA Hijacking on Game Boy"><meta name="og:description" content="A technique that allows you to run custom code in most GB/SGB/CGB games, provided you have an ACE exploit."><link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"><meta property="og:site_name" content="gbdev.io"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@gbdev0"><meta name="og:image" content="https://gbdev.io/images/gbinternals.png"><title>DMA Hijacking | gbdev</title><meta name="description" content="game boy development scene">
    <link rel="modulepreload" href="/assets/app.b9b4ba2d.js"><link rel="modulepreload" href="/assets/dma_hijacking.html.c3182293.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/dma_hijacking.html.9b48da73.js">
    <link rel="stylesheet" href="/assets/style.67120b7c.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">gbdev</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://www.getrevue.co/profile/gbdev" rel="noopener noreferrer" target="_blank" aria-label="Newsletter"><!--[--><!--]--> Newsletter <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Community"><span class="title">Community</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Community"><span class="title">Community</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/chat" class="" aria-label="Chat"><!--[--><!--]--> Chat <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/contribute" class="" aria-label="Contribute"><!--[--><!--]--> Contribute <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/gbcompo21" class="" aria-label="GB Competition 2021"><!--[--><!--]--> GB Competition 2021 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/resources" class="" aria-label="Resources"><!--[--><!--]--> Resources <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Guides"><span class="title">Guides</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Guides"><span class="title">Guides</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/guides/tools" class="" aria-label="Choosing development tools"><!--[--><!--]--> Choosing development tools <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/asmstyle" class="" aria-label="ASM Style recomendations"><!--[--><!--]--> ASM Style recomendations <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/lyc_timing" class="" aria-label="The Timing of LYC STAT Handlers"><!--[--><!--]--> The Timing of LYC STAT Handlers <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/deadcscroll" class="" aria-label="Dead C Scroll"><!--[--><!--]--> Dead C Scroll <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/dma_hijacking" class="router-link-active" aria-label="DMA Hijacking"><!--[--><!--]--> DMA Hijacking <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://eldred.fr/gb-asm-tutorial" rel="noopener noreferrer" target="_blank" aria-label="GB ASM Programming Guide"><!--[--><!--]--> GB ASM Programming Guide <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://www.getrevue.co/profile/gbdev" rel="noopener noreferrer" target="_blank" aria-label="Newsletter"><!--[--><!--]--> Newsletter <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Community"><span class="title">Community</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Community"><span class="title">Community</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/chat" class="" aria-label="Chat"><!--[--><!--]--> Chat <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/contribute" class="" aria-label="Contribute"><!--[--><!--]--> Contribute <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/gbcompo21" class="" aria-label="GB Competition 2021"><!--[--><!--]--> GB Competition 2021 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a href="/resources" class="" aria-label="Resources"><!--[--><!--]--> Resources <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Guides"><span class="title">Guides</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Guides"><span class="title">Guides</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/guides/tools" class="" aria-label="Choosing development tools"><!--[--><!--]--> Choosing development tools <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/asmstyle" class="" aria-label="ASM Style recomendations"><!--[--><!--]--> ASM Style recomendations <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/lyc_timing" class="" aria-label="The Timing of LYC STAT Handlers"><!--[--><!--]--> The Timing of LYC STAT Handlers <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/deadcscroll" class="" aria-label="Dead C Scroll"><!--[--><!--]--> Dead C Scroll <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/guides/dma_hijacking" class="router-link-active" aria-label="DMA Hijacking"><!--[--><!--]--> DMA Hijacking <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://eldred.fr/gb-asm-tutorial" rel="noopener noreferrer" target="_blank" aria-label="GB ASM Programming Guide"><!--[--><!--]--> GB ASM Programming Guide <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p class="sidebar-item sidebar-heading">DMA Hijacking <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/guides/dma_hijacking.html#what-is-it" class="router-link-active router-link-exact-active sidebar-item" aria-label="What is it?"><!--[--><!--]--> What is it? <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guides/dma_hijacking.html#how-is-it-done" class="router-link-active router-link-exact-active sidebar-item" aria-label="How is it done?"><!--[--><!--]--> How is it done? <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/guides/dma_hijacking.html#patching-the-code" class="router-link-active router-link-exact-active sidebar-item" aria-label="Patching the code"><!--[--><!--]--> Patching the code <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/guides/dma_hijacking.html#with-cartswap" class="router-link-active router-link-exact-active sidebar-item" aria-label="With Cartswap"><!--[--><!--]--> With Cartswap <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/guides/dma_hijacking.html#details" class="router-link-active router-link-exact-active sidebar-item" aria-label="Details"><!--[--><!--]--> Details <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/guides/dma_hijacking.html#trivia" class="router-link-active router-link-exact-active sidebar-item" aria-label="Trivia"><!--[--><!--]--> Trivia <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/guides/dma_hijacking.html#notes" class="router-link-active router-link-exact-active sidebar-item" aria-label="Notes"><!--[--><!--]--> Notes <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="dma-hijacking" tabindex="-1"><a class="header-anchor" href="#dma-hijacking" aria-hidden="true">#</a> DMA Hijacking</h1><p>Written by <a href="https://github.com/ISSOtm" target="_blank" rel="noopener noreferrer">ISSOtm<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p><div class="custom-container tip"><p class="custom-container-title">TARGET AUDIENCE</p><p>Unlike most resources here, this guide is not very useful to developers or even ROM hackers, but rather to glitch-hunters and exploit developers.</p></div><hr><h2 id="what-is-it" tabindex="-1"><a class="header-anchor" href="#what-is-it" aria-hidden="true">#</a> What is it?</h2><p><em>OAM DMA hijacking</em> is a simple technique that allows you to run custom code in most GB/SGB/CGB games, provided you have an ACE exploit.</p><p>One would be quick to point out that if you have an ACE exploit, you can already execute custom code. So then, what is the point? It&#39;s that code ran through DMA Hijacking will be run <em>on every game frame</em> (for most games, at least).</p><h2 id="how-is-it-done" tabindex="-1"><a class="header-anchor" href="#how-is-it-done" aria-hidden="true">#</a> How is it done?</h2><p>If you are familiar enough with <a href="https://gbdev.io/pandocs/OAM" target="_blank" rel="noopener noreferrer">OAM<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, you may know about a feature called <em>OAM DMA</em>.</p><p><a href="https://gbdev.io/pandocs/OAM_DMA_Transfer" target="_blank" rel="noopener noreferrer">OAM DMA<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> is a convenient feature that allows quickly updating the on-screen <a href="https://gbdev.io/pandocs/Rendering#objects" target="_blank" rel="noopener noreferrer">&quot;objects&quot;<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> (often known as &quot;sprites&quot;) quickly—which is especially useful since it typically needs to occur on every frame. However, using OAM DMA requires a small routine to be copied to HRAM and then run from there.</p><p>Interestingly, most games only copy the routine when starting up, and then execute it on every subsequent frame. But, <em>if we modified that routine while the game is running</em>, then the game will happily run the customized routine!</p><h3 id="patching-the-code" tabindex="-1"><a class="header-anchor" href="#patching-the-code" aria-hidden="true">#</a> Patching the code</h3><p>Here is the standard routine, given by Nintendo in the GB programming manual (using <a href="https://rgbds.gbdev.io/docs/rgbasm.5" target="_blank" rel="noopener noreferrer">RGBASM syntax<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> and a symbol from <a href="https://github.com/gbdev/hardware.inc" target="_blank" rel="noopener noreferrer"><code>hardware.inc</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>):</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">    ld a, HIGH(OAMBuffer)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ldh [rDMA], a  </span><span style="color:#616E88;">; $FF46</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, </span><span style="color:#B48EAD;">40</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    jr nz, DMALoop</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>The simplest way to get custom code (let&#39;s call it <code>DMAHook</code>) executed would be to overwrite the first few bytes with a jump to <code>DMAHook</code>:</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">jp</span><span style="color:#D8DEE9FF;"> DMAHook</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">db</span><span style="color:#D8DEE9FF;"> </span><span style="color:#B48EAD;">$46</span><span style="color:#D8DEE9FF;">    </span><span style="color:#616E88;">; Leftover operand byte of `ldh [rDMA], a`</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, </span><span style="color:#B48EAD;">40</span><span style="color:#D8DEE9FF;">  </span><span style="color:#616E88;">; None of this is executed</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    jr nz, DMALoop</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="highlight-lines"><div class="highlight-line"> </div><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Now, overwriting the routine like this works for our purposes, but comes with a large drawback: the routine isn&#39;t doing what it is intended to anymore, and so the game&#39;s objects won&#39;t update (unless you manually copied OAM, but beware of <a href="https://gbdev.io/pandocs/OAM_Corruption_Bug" target="_blank" rel="noopener noreferrer">the OAM corruption bug<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>). Further, it&#39;s not possible to write to <code>rDMA</code> from <code>DMAHook</code>, as the write and subsequent wait loop <strong>must</strong> be executed from HRAM.</p><p>But, there is a solution.</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">call</span><span style="color:#D8DEE9FF;"> DMAHook</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ldh [c], a  </span><span style="color:#616E88;">; A write to `rDMA`, set up by DMAHook</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, </span><span style="color:#B48EAD;">40</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    jr nz, DMALoop</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="highlight-lines"><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Provided that <code>DMAHook</code> returns with properly set registers, this allows writing to <code>rDMA</code> in the single HRAM byte left by the <code>call</code> instruction. Here is a pattern for DMAHook :</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#88C0D0;">DMAHook</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#616E88;">;;  Custom code, do whatever you want, it&#39;s VBlank time!</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#616E88;">; ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld c, LOW(rDMA)  </span><span style="color:#616E88;">; $46</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, HIGH(OAMBuffer)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>DMAHook</code> can live anywhere in memory, but typically it will be in WRAM. It will be executed in the context of the VBlank interrupt, so for most games interrupts will be disabled, etc.</p><h2 id="with-cartswap" tabindex="-1"><a class="header-anchor" href="#with-cartswap" aria-hidden="true">#</a> With Cartswap</h2><p>DMA Hijacking is also useful when combined with <a href="https://gist.github.com/ISSOtm/3008fd73ec66cb56f1caecfcc8b6fb6f" target="_blank" rel="noopener noreferrer">cartswap<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> (swapping carts without shutting the console down, concept found by furrtek, developed by Cryo and me on the GCL forums), because it allows &quot;transporting&quot; ACE to other games.</p><p>General procedure:</p><ol><li>Acquire ACE in the &quot;source&quot; game</li><li>Perform cartswap, insert the &quot;victim&quot; game</li><li>&quot;Pseudo-initialize&quot; the victim</li><li>Place the modified DMA handler in HRAM</li><li>Transfer control back to the victim&#39;s ROM</li><li>????</li><li>Profit!</li></ol><p>Possible applications are checking for a button combo to trigger specific code (for example, credits warp), checking one or multiple memory addresses to detect a certain game state, etc.</p><p>Possible &quot;attack vectors&quot;, i.e. ways of affecting the victim game, are setting certain memory addresses (like a GameShark), or even better: manipulating the stack.</p><p>Here is a video demonstration:</p><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/BNyDmZlbsNI" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>Manipulating the stack with this technique can not crash if the triggering game state is specific enough. I achieved text pointer manipulation in Pokémon Red this way. (This is not a ROM hack!)</p><iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/yXy5sYZR9mk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><h3 id="details" tabindex="-1"><a class="header-anchor" href="#details" aria-hidden="true">#</a> Details</h3><p>This new technique hinges on breaking one of any game&#39;s core assumptions: its entry point. You see, normally, <a href="https://gbdev.io/pandocs/The_Cartridge_Header#0100-0103---entry-point" target="_blank" rel="noopener noreferrer">the console transfers control to the game at address $0100<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, so any code placed there is designed to initialize all of the game&#39;s systems, in particular their memory.</p><p>However, since we have control of the CPU, we can jump to any location in the game&#39;s ROM, which allows bypassing some of said initialization. Doing so without any precautions is very likely to go haywire, though—it is important to initialize <em>enough</em> that the game runs, but not <em>too much</em> that it would end up overwriting the code we are trying to inject. This is what I call &quot;<strong>pseudo-initialization</strong>&quot;.</p><p>Another important part is finding some free space to store the hook code in. The stack area can work surprisingly well for this, as many games appear to over-allocate (e.g. 256 bytes when the typical usage doesn&#39;t go beyond 32).</p><p>None of this has a silver bullet: the game&#39;s init code must be analyzed, and its memory usage carefully scrutinized in order to dig up enough free space for your hook.</p><h2 id="trivia" tabindex="-1"><a class="header-anchor" href="#trivia" aria-hidden="true">#</a> Trivia</h2><p>DMA hijacking works similarly to the GameShark: that device intercepts accesses to the ROM, and when it detects that the VBlank handler is being run, it &quot;overlays&quot; different instructions that apply the stored codes, and jump back to the actual handler.</p><p>And, why yes, it is possible to use DMA hijacking to emulate GameShark codes! <a href="http://gbdev.gg8.se/forums/viewtopic.php?id=430" target="_blank" rel="noopener noreferrer">Here is a proof-of-concept in Pokémon Red<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p><h2 id="notes" tabindex="-1"><a class="header-anchor" href="#notes" aria-hidden="true">#</a> Notes</h2><ul><li><p>I encountered some games that don&#39;t transfer OAM unless a specific flag is set; I believe that it is always possible to override this limitation, by setting the flag back in the hook.</p></li><li><p>The OAM DMA routine is often placed at $FF80 in commercial games.</p></li><li><p>The patched OAM DMA routine with our hook may be modifying registers that the game expects to be preserved. This is all dependent on the target game, so no general advice can be given.</p><p>Additionally, if the hook takes too long, it may cause code expecting to run in VBlank to break. This might be solved for example by manipulating the stack and injecting an additional return address; here is an example.</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">jp</span><span style="color:#D8DEE9FF;"> DMAHook</span></span>
<span class="line"><span style="color:#88C0D0;">PostDMAHook</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ldh [c], a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, </span><span style="color:#B48EAD;">40</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    jr nz, DMALoop</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">jp</span><span style="color:#D8DEE9FF;"> hl</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">pop</span><span style="color:#D8DEE9FF;"> hl  </span><span style="color:#616E88;">; Get original return address</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld bc, PostHandlerHook  </span><span style="color:#616E88;">; Address of code that will be executed once the VBlank handler finishes</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">push</span><span style="color:#D8DEE9FF;"> bc  </span><span style="color:#616E88;">; Inject return address for VBlank handler</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld c, LOW(rDMA)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, HIGH(OAMBuffer)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">jp</span><span style="color:#D8DEE9FF;"> PostDMAHook</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>(Since the handler almost certainly performs some <code>pop</code>s before returning, you will almost certainly need more complex stack manipulation, but that&#39;s the gist of it.)</p></li><li><p>Some games have a slightly more clever routine in HRAM, that omits the initial <code>ld a, HIGH(OAMBuffer)</code> saving 2 bytes of HRAM.</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">    ldh [rDMA], a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, </span><span style="color:#B48EAD;">40</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    jr nz, DMALoop</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>They can still be patched by overwriting the <code>ld a, 40</code> instead, and using e.g. the <code>b</code> register for the loop:</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">call</span><span style="color:#D8DEE9FF;"> DMAHook</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ldh [c], a  </span><span style="color:#616E88;">; Write to rDMA</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> b</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    jr nz, DMALoop</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="highlight-lines"><div class="highlight-line"> </div><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Then <code>DMAHook</code> needs to return with <code>b</code> additionally set to 40:</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#88C0D0;">DMAHook</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#616E88;">;;  Custom code, do whatever you want, it&#39;s VBlank time!</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#616E88;">; ...</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld bc, </span><span style="color:#B48EAD;">40</span><span style="color:#D8DEE9FF;"> &lt;&lt; </span><span style="color:#B48EAD;">8</span><span style="color:#D8DEE9FF;"> | LOW(rDMA)  </span><span style="color:#616E88;">; 40 in B, $46 in C</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    ld a, HIGH(OAMBuffer)</span></span>
<span class="line"><span style="color:#D8DEE9FF;">    </span><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>However, if the OAM buffer address passed to the function (in <code>a</code>) is not static, <code>push af</code> and <code>pop af</code> will have to be used instead of <code>ld a, HIGH(OAMBuffer)</code>.</p></li></ul><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/gbdev/gbdev.github.io/edit/dev/website/guides/dma_hijacking.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.b9b4ba2d.js" defer></script>
  </body>
</html>
